---

- name: Gather package facts
  ansible.builtin.package_facts:

- name: Install unzip for ubuntu
  become: true
  when: ansible_distribution == "Ubuntu"
  ansible.builtin.package:
    name: unzip
    state: present

- name: Check for ulauncher
  when: "'ulauncher' not in ansible_facts.packages"
  ansible.builtin.debug:
    msg: "Unable to find ulauncher in installed packages"

- name: Check if lingering is already enabled
  become: true
  ansible.builtin.command:
    cmd: "loginctl show-user {{ user }} --property=Linger"
  register: linger_status
  changed_when: false
  failed_when: linger_status.rc not in [0, 1]

# Warning the rc based check is rather a guess - but worked
- name: Enable lingering if not already enabled
  when: linger_status.rc != 0
  become: true
  ansible.builtin.command:
    cmd: "loginctl enable-linger {{ user }}"
  register: linger_active
  changed_when: linger_active.rc == 0

- name: Ensure ulauncher service is enabled
  become: true
  become_user: "{{ user }}"
  ansible.builtin.systemd_service:
    name: ulauncher.service
    enabled: true
    scope: "user"

- name: Ansible check directory
  become: true
  become_user: "{{ user }}"
  ansible.builtin.stat:
    path: "{{ ulauncher_settings_dir }}"
  register: settings_dir

- name: "Create settings directory for {{ user }}"
  become: true
  become_user: "{{ user }}"
  when: not settings_dir.stat.exists
  ansible.builtin.file:
    path: "{{ ulauncher_themes_dir }}"
    state: directory
    mode: "0755"

- name: Get current display server
  ansible.builtin.command:
    cmd: "grep '^#WaylandEnable=false' /etc/gdm/custom.conf"
  register: wayland_check
  changed_when: false
  failed_when: false

- name: Disable Alt+Space for 'Activate the Window menu'
  become: true
  become_user: "{{ user }}"
  when: "'gnome-shell' in ansible_facts.packages"
  community.general.dconf:
    key: "/org/gnome/desktop/wm/keybindings/activate-window-menu"
    value: "{{ '@as []' | string }}"
    state: present

- name: "Include wayland adjustments for {{ user }}"
  when: wayland_check.rc == 0 and 'gnome-shell' in ansible_facts.packages
  ansible.builtin.include_tasks:
    file: wayland.yml

- name: "Write app settings for {{ user }}"
  become: true
  become_user: "{{ user }}"
  ansible.builtin.copy:
    dest: "{{ (ulauncher_settings_dir, 'settings.json') | ansible.builtin.path_join }}"
    content: "{{ ulauncher_settings | to_json(indent=4) }}"
    mode: "0644"

- name: "Write extension settings for {{ user }}"
  become: true
  become_user: "{{ user }}"
  ansible.builtin.copy:
    dest: "{{ (ulauncher_settings_dir, 'extensions.json') | ansible.builtin.path_join }}"
    content: "{{ ulauncher_extensions | to_json(indent=4) }}"
    mode: "0644"

- name: "Write shortcut settings for {{ user }}"
  become: true
  become_user: "{{ user }}"
  ansible.builtin.copy:
    dest: "{{ (ulauncher_settings_dir, 'shortcuts.json') | ansible.builtin.path_join }}"
    content: "{}"
    mode: "0644"

- name: Set up themes
  loop: "{{ ulauncher_github_repo_theme }}"
  loop_control:
    loop_var: ulauncher_theme
    label: "{{ ulauncher_theme.name }}"
  ansible.builtin.include_tasks:
    file: themes.yml

...
